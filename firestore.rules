
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // Check if user is logged in
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if the user is accessing their own data
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Check if the user has the 'admin' role in their user document
    // Note: This costs 1 read per write operation.
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Collections ---

    // SEASONS:
    // Publicly readable, only admins can write.
    match /seasons/{seasonId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // USERS:
    // Anyone signed in can read users (for leaderboards/search).
    // Only the user themselves or an admin can edit the profile.
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId) || isAdmin();
    }

    // USERNAMES:
    // Reserve usernames as documents keyed by lowercase username.
    match /usernames/{usernameId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && !exists(/databases/$(database)/documents/usernames/$(usernameId));
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // TEAMS & DRIVERS & SCHEDULE:
    // These are now subcollections of a season. Rules need to be nested.
    // This is handled by the season-specific rule below.

    // PREDICTIONS:
    // Users can read any prediction (open game).
    // Users can only write their own prediction.
    match /seasons/{seasonId}/predictions/{predictionId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isAdmin();
    }

    // RESULTS & DRAFT_RESULTS:
    // Publicly readable (official). Drafts only for admins.
    match /seasons/{seasonId}/results/{gpId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /seasons/{seasonId}/draft_results/{gpId} {
      allow read, write: if isAdmin();
    }

    // TOURNAMENTS:
    match /seasons/{seasonId}/tournaments/{tournamentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn()
                    && (resource.data.creatorId == request.auth.uid || isAdmin())
                    && request.resource.data.creatorId == resource.data.creatorId;
      allow delete: if isSignedIn() && (resource.data.creatorId == request.auth.uid || isAdmin());
    }

    // POINT ADJUSTMENTS:
    match /seasons/{seasonId}/pointAdjustments/{adjId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // SEASONAL CATALOGUE (Teams, Drivers, Schedule)
    match /seasons/{seasonId}/{collection}/{docId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    // PUBLIC GP STANDINGS (subcollection)
    match /seasons/{seasonId}/public_gp_standings/{gpId}/standings/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- Root Level Collections (Non-Seasonal) ---

    // NOTIFICATIONS:
    // Users can only read/write their own notifications.
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && (resource.data.toUserId == request.auth.uid || resource.data.fromUserId == request.auth.uid);
      allow create: if isSignedIn(); // Users create notifications (pokes, invites) for others
      allow update, delete: if isSignedIn() && resource.data.toUserId == request.auth.uid;
    }

    // SCHEDULED NOTIFICATIONS (admin only)
    match /scheduled_notifications/{notificationId} {
      allow read, write: if isAdmin();
    }

    // SETTINGS (admin only)
    match /settings/{docId} {
      allow read, write: if isAdmin();
    }

    // PUSH OPEN EVENTS:
    // Clients create an event when opening a scheduled push.
    match /push_open_events/{eventId} {
      allow create: if isSignedIn() && request.resource.data.openedBy == request.auth.uid;
      allow read, update, delete: if isAdmin();
    }
  }
}
